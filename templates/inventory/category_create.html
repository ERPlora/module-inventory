{% extends "core/app_base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Crear Categoría" %} - CPOS Hub{% endblock %}

{% block content %}
<div class="p-4">
    <ion-card class="m-4">
        <ion-card-header class="p-0">
            <ion-toolbar>
                <ion-buttons slot="start">
                    <ion-button href="/modules/inventory/categories/" fill="clear">
                        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
                    </ion-button>
                </ion-buttons>
                <ion-title>{% trans "Crear Categoría" %}</ion-title>
            </ion-toolbar>
        </ion-card-header>

        <form id="categoryForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <ion-card-content>
                <!-- Nombre -->
                <ion-item>
                    <ion-input
                        label="{% trans 'Nombre' %} *"
                        label-placement="floating"
                        name="name"
                        placeholder="{% trans 'Ingrese el nombre de la categoría' %}"
                        required>
                    </ion-input>
                </ion-item>

                <!-- Descripción -->
                <ion-item>
                    <ion-textarea
                        label="{% trans 'Descripción' %}"
                        label-placement="floating"
                        name="description"
                        placeholder="{% trans 'Ingrese la descripción de la categoría' %}"
                        rows="3"></ion-textarea>
                </ion-item>

                <!-- Icono -->
                <ion-item>
                    <ion-input
                        label="{% trans 'Icono' %}"
                        label-placement="floating"
                        name="icon"
                        value="cube-outline"
                        placeholder="cube-outline">
                    </ion-input>
                </ion-item>

                <!-- Color -->
                <ion-item>
                    <ion-label position="stacked">{% trans "Color" %}</ion-label>
                    <input
                        type="color"
                        name="color"
                        value="#3880ff"
                        style="width: 100%; height: 40px; border: none; cursor: pointer;">
                </ion-item>

                <!-- Tax Class -->
                <ion-item>
                    <ion-select
                        name="tax_class_id"
                        label="{% trans 'Tax Class' %}"
                        label-placement="floating"
                        placeholder="{% trans 'Select tax class' %}">
                        <ion-select-option value="">{% trans "No Tax Class" %}</ion-select-option>
                        {% for tc in tax_classes %}
                        <ion-select-option value="{{ tc.id }}">{{ tc.name }} ({{ tc.rate }}%)</ion-select-option>
                        {% endfor %}
                    </ion-select>
                </ion-item>

                <!-- Orden -->
                <ion-item>
                    <ion-input
                        label="{% trans 'Orden' %}"
                        label-placement="floating"
                        name="order"
                        type="number"
                        value="0"
                        placeholder="0">
                    </ion-input>
                </ion-item>

                <!-- Imagen -->
                <ion-item>
                    <ion-label position="stacked">{% trans "Imagen de la Categoría" %}</ion-label>
                    <div style="width: 100%; margin-top: 8px;">
                        <div class="flex items-center justify-center w-full" id="dropzoneContainer">
                            <label for="categoryImage" id="dropzoneLabel" class="flex flex-col items-center justify-center w-full h-40 bg-neutral-secondary-medium border-2 border-dashed border-default-strong rounded-base cursor-pointer hover:bg-neutral-tertiary-medium">
                                <div class="flex flex-col items-center justify-center text-body pt-5 pb-6">
                                    <svg class="w-8 h-8 mb-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h3a3 3 0 0 0 0-6h-.025a5.56 5.56 0 0 0 .025-.5A5.5 5.5 0 0 0 7.207 9.021C7.137 9.017 7.071 9 7 9a4 4 0 1 0 0 8h2.167M12 19v-9m0 0-2 2m2-2 2 2"/>
                                    </svg>
                                    <p class="mb-1 text-sm"><span class="font-semibold">{% trans "Click to upload" %}</span> {% trans "or drag and drop" %}</p>
                                    <p class="text-xs text-center">{% trans "PNG, JPG or GIF (MAX. 800x400px)" %}</p>
                                </div>
                                <input id="categoryImage" name="image" type="file" class="hidden" accept="image/*" />
                            </label>
                        </div>
                        <div id="categoryImagePreview" style="margin-top: 12px; display: none; text-align: center;">
                            <img id="categoryImagePreviewImg" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <button type="button" id="removeImageBtn" style="margin-top: 8px; padding: 6px 12px; background: var(--ion-color-danger); color: white; border: none; border-radius: 4px; cursor-pointer; font-size: 14px;">
                                {% trans "Remove Image" %}
                            </button>
                        </div>
                    </div>
                </ion-item>
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const fileInput = document.getElementById('categoryImage');
                        const previewDiv = document.getElementById('categoryImagePreview');
                        const previewImg = document.getElementById('categoryImagePreviewImg');
                        const dropzoneLabel = document.getElementById('dropzoneLabel');
                        const removeBtn = document.getElementById('removeImageBtn');

                        // Preview on file select
                        if (fileInput && previewDiv && previewImg) {
                            fileInput.addEventListener('change', function(e) {
                                const file = e.target.files[0];
                                if (file && file.type.startsWith('image/')) {
                                    const reader = new FileReader();
                                    reader.onload = function(event) {
                                        previewImg.src = event.target.result;
                                        previewDiv.style.display = 'block';
                                        dropzoneLabel.style.display = 'none';
                                    };
                                    reader.readAsDataURL(file);
                                }
                            });
                        }

                        // Remove image button
                        if (removeBtn) {
                            removeBtn.addEventListener('click', function() {
                                fileInput.value = '';
                                previewDiv.style.display = 'none';
                                dropzoneLabel.style.display = 'flex';
                                previewImg.src = '';
                            });
                        }
                    });
                </script>

                <!-- Botones de Acción -->
                <div class="mt-6 flex gap-2">
                    <ion-button type="submit" expand="block" color="success">
                        <ion-icon slot="start" name="save-outline"></ion-icon>
                        {% trans "Crear Categoría" %}
                    </ion-button>
                    <ion-button type="button" expand="block" fill="outline" href="/modules/inventory/categories/">
                        {% trans "Cancelar" %}
                    </ion-button>
                </div>
            </ion-card-content>
        </form>
    </ion-card>
</div>

<script>
document.getElementById('categoryForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    try {
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            // Show success toast
            const toast = document.createElement('ion-toast');
            toast.message = data.message;
            toast.duration = 2000;
            toast.color = 'success';
            toast.position = 'top';
            document.body.appendChild(toast);
            await toast.present();

            // Redirect to categories list
            setTimeout(() => {
                window.location.href = '/modules/inventory/categories/';
            }, 1000);
        } else {
            // Show error toast
            const toast = document.createElement('ion-toast');
            toast.message = data.message || '{% trans "Error al crear" %}';
            toast.duration = 3000;
            toast.color = 'danger';
            toast.position = 'top';
            document.body.appendChild(toast);
            await toast.present();
        }
    } catch (error) {
        console.error('Error:', error);
        const toast = document.createElement('ion-toast');
        toast.message = '{% trans "Error al procesar la solicitud" %}';
        toast.duration = 3000;
        toast.color = 'danger';
        toast.position = 'top';
        document.body.appendChild(toast);
        await toast.present();
    }
});
</script>
{% endblock %}
