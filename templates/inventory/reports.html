{% extends "core/app_base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Informes de Inventario" %} - CPOS Hub{% endblock %}

{% block content %}
<div class="p-4">
    <ion-card class="m-4">
        <ion-card-header class="p-0">
            <ion-toolbar>
                <ion-buttons slot="start">
                    <ion-button href="/plugins/inventory/" fill="clear">
                        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
                    </ion-button>
                </ion-buttons>
                <ion-title>{% trans "Informes de Inventario" %}</ion-title>
            </ion-toolbar>
        </ion-card-header>

        <ion-card-content>
            <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="cube-outline" class="text-2xl text-primary"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "Total Productos" %}</div>
                        <div class="text-2xl font-semibold">{{ total_products }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-success/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="checkmark-circle-outline" class="text-2xl text-success"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "En Stock" %}</div>
                        <div class="text-2xl font-semibold">{{ products_in_stock }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-warning/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="alert-circle-outline" class="text-2xl text-warning"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "Stock Bajo" %}</div>
                        <div class="text-2xl font-semibold">{{ products_low_stock }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-success/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="cash-outline" class="text-2xl text-success"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "Valor Total" %}</div>
                        <div class="text-2xl font-semibold">${{ total_inventory_value|floatformat:2 }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Additional Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-danger/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="close-circle-outline" class="text-2xl text-danger"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "Sin Stock" %}</div>
                        <div class="text-2xl font-semibold">{{ products_out_of_stock }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="albums-outline" class="text-2xl text-primary"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "Categorías" %}</div>
                        <div class="text-2xl font-semibold">{{ total_categories }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-success/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="layers-outline" class="text-2xl text-success"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "Unidades Totales" %}</div>
                        <div class="text-2xl font-semibold">{{ total_units }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-warning/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="trending-down-outline" class="text-2xl text-warning"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">{% trans "Valor Costo" %}</div>
                        <div class="text-2xl font-semibold">${{ total_cost_value|floatformat:2 }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Stock Status by Category -->
    <ion-card class="mb-6">
        <ion-card-header>
            <ion-card-title>{% trans "Stock por Categoría" %}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
            {% if category_stats %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead style="background: var(--ion-color-step-50);">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Categoría" %}</th>
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Productos" %}</th>
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Unidades" %}</th>
                            <th class="px-4 py-3 text-right text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Valor" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in category_stats %}
                        <tr class="border-b" style="border-color: var(--ion-border-color);">
                            <td class="px-4 py-3 text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded flex items-center justify-center" style="background: {{ stat.color }}20;">
                                        <ion-icon name="{{ stat.icon }}" style="color: {{ stat.color }};"></ion-icon>
                                    </div>
                                    <span>{{ stat.name }}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-center text-sm">{{ stat.product_count }}</td>
                            <td class="px-4 py-3 text-center text-sm">{{ stat.total_stock }}</td>
                            <td class="px-4 py-3 text-right text-sm font-semibold" style="color: var(--ion-color-success);">${{ stat.total_value|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-8" style="color: var(--ion-color-medium);">
                <ion-icon name="albums-outline" style="font-size: 48px;"></ion-icon>
                <p class="mt-2">{% trans "No hay categorías con productos" %}</p>
            </div>
            {% endif %}
        </ion-card-content>
    </ion-card>

    <!-- Top Products by Value -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <ion-card class="m-0">
            <ion-card-header>
                <ion-card-title>{% trans "Productos con Mayor Valor en Stock" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                {% if top_products_by_value %}
                <div class="space-y-3">
                    {% for product in top_products_by_value %}
                    <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--ion-color-light);">
                        <div class="flex items-center gap-3">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-10 h-10 object-cover rounded-lg">
                            {% else %}
                            <div class="w-10 h-10 flex items-center justify-center rounded-lg" style="background: var(--ion-color-step-100);">
                                <ion-icon name="cube-outline" style="color: var(--ion-color-medium);"></ion-icon>
                            </div>
                            {% endif %}
                            <div>
                                <div class="font-medium" style="color: var(--ion-text-color);">{{ product.name }}</div>
                                <div class="text-xs" style="color: var(--ion-color-medium);">
                                    {{ product.stock }} unidades × ${{ product.price|floatformat:2 }}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold" style="color: var(--ion-color-success);">${{ product.stock_value|floatformat:2 }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8" style="color: var(--ion-color-medium);">
                    <p>{% trans "No hay productos en stock" %}</p>
                </div>
                {% endif %}
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-header>
                <ion-card-title>{% trans "Productos con Mayor Stock" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                {% if top_products_by_stock %}
                <div class="space-y-3">
                    {% for product in top_products_by_stock %}
                    <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--ion-color-light);">
                        <div class="flex items-center gap-3">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-10 h-10 object-cover rounded-lg">
                            {% else %}
                            <div class="w-10 h-10 flex items-center justify-center rounded-lg" style="background: var(--ion-color-step-100);">
                                <ion-icon name="cube-outline" style="color: var(--ion-color-medium);"></ion-icon>
                            </div>
                            {% endif %}
                            <div>
                                <div class="font-medium" style="color: var(--ion-text-color);">{{ product.name }}</div>
                                <div class="text-xs" style="color: var(--ion-color-medium);">
                                    ${{ product.price|floatformat:2 }} c/u
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold" style="color: var(--ion-color-primary);">{{ product.stock }} unidades</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8" style="color: var(--ion-color-medium);">
                    <p>{% trans "No hay productos en stock" %}</p>
                </div>
                {% endif %}
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Critical Stock Alert -->
    {% if critical_stock_products %}
    <ion-card class="m-0">
        <ion-card-header>
            <div class="flex items-center gap-2">
                <ion-icon name="warning-outline" class="text-danger"></ion-icon>
                <ion-card-title>{% trans "Productos en Stock Crítico" %}</ion-card-title>
            </div>
        </ion-card-header>
        <ion-card-content>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead style="background: var(--ion-color-step-50);">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Producto" %}</th>
                            <th class="px-4 py-3 text-left text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "SKU" %}</th>
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Stock Actual" %}</th>
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Umbral" %}</th>
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Acciones" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in critical_stock_products %}
                        <tr class="border-b" style="border-color: var(--ion-border-color);">
                            <td class="px-4 py-3 text-sm">
                                <div class="flex items-center gap-3">
                                    {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-10 h-10 object-cover rounded-lg">
                                    {% else %}
                                    <div class="w-10 h-10 flex items-center justify-center rounded-lg" style="background: var(--ion-color-light);">
                                        <ion-icon name="cube-outline" style="color: var(--ion-color-medium);"></ion-icon>
                                    </div>
                                    {% endif %}
                                    <span>{{ product.name }}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm font-mono" style="color: var(--ion-color-medium);">{{ product.sku }}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: var(--ion-color-danger-tint); color: var(--ion-color-danger-contrast);">
                                    {{ product.stock }}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center text-sm" style="color: var(--ion-color-medium);">{{ product.low_stock_threshold }}</td>
                            <td class="px-4 py-3 text-center">
                                <ion-button size="small" fill="clear" href="/plugins/inventory/products/{{ product.id }}/edit/">
                                    <ion-icon slot="icon-only" name="create-outline"></ion-icon>
                                </ion-button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            </ion-card-content>
        </ion-card>
        {% endif %}
        </ion-card-content>
    </ion-card>
</div>
{% endblock %}
