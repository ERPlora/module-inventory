{% extends "ui/module_content.html" %}
{% load static i18n ui %}

{% block header_actions %}
<ion-button size="default" fill="outline" onclick="document.getElementById('importFileInput').click()" title="{% trans 'Import CSV/Excel' %}">
    <ion-icon slot="icon-only" name="cloud-upload-outline"></ion-icon>
</ion-button>
<input type="file" id="importFileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileImport(this)">

<ion-button size="default" fill="outline" href="{% url 'inventory:export_csv' %}" title="{% trans 'Export to CSV' %}">
    <ion-icon slot="icon-only" name="download-outline"></ion-icon>
</ion-button>

<ion-button size="default" href="{% url 'inventory:product_create' %}" title="{% trans 'New Product' %}">
    <ion-icon slot="icon-only" name="add-outline"></ion-icon>
</ion-button>
{% endblock %}

{% block content %}
{# Search Bar #}
<div class="filter-bar mb-md">
    <ion-searchbar
        type="text"
        name="search"
        value="{{ search }}"
        placeholder="{% trans 'Search products...' %}"
        hx-get="{% url 'inventory:products_list' %}"
        hx-target="#products-table-container"
        hx-trigger="input changed delay:300ms, search"
        hx-include="[name='page'],[name='order_by'],[name='per_page']"
    ></ion-searchbar>
</div>

{# Products Table #}
<ion-card class="m-0">
    <ion-card-content class="p-0">
        <div id="products-table-container">
            {% include "inventory/partials/products_table_partial.html" %}
        </div>
    </ion-card-content>
</ion-card>

<script>
// Delete product using Alpine.js $store.ui
async function confirmDeleteProduct(productId, productName, buttonElement) {
    Alpine.store('ui').confirmDelete(
        `/modules/inventory/products/${productId}/delete/`,
        productName,
        'DELETE',
        buttonElement
    );
}

// Import handler using Alpine.js $store.ui
async function handleFileImport(input) {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    const fileName = file.name.toLowerCase();
    let importUrl;
    if (fileName.endsWith('.csv')) {
        importUrl = '/modules/inventory/products/import/csv/';
    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        importUrl = '/modules/inventory/products/import/excel/';
    } else {
        Alpine.store('ui').error('{% trans "Invalid file format. Use CSV or Excel" %}');
        input.value = '';
        return;
    }

    // Show loading toast
    const loadingToast = document.createElement('ion-toast');
    loadingToast.message = '{% trans "Importing products..." %}';
    loadingToast.duration = 0;
    loadingToast.position = 'top';
    document.body.appendChild(loadingToast);
    await loadingToast.present();

    try {
        const response = await fetch(importUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': Alpine.store('ui').getCsrfToken(),
            }
        });

        const result = await response.json();
        await loadingToast.dismiss();

        if (response.ok) {
            Alpine.store('ui').success(result.message || '{% trans "Products imported successfully" %}');
            window.location.reload();
        } else {
            Alpine.store('ui').error(result.error || '{% trans "Error importing products" %}');
        }
    } catch (error) {
        await loadingToast.dismiss();
        console.error('Import error:', error);
        Alpine.store('ui').error('{% trans "Error importing products" %}');
    }

    input.value = '';
}
</script>
{% endblock %}
