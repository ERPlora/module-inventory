{% extends "core/app_base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Productos - CPOS Hub{% endblock %}

{% block content %}
<div class="p-4">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="cube-outline" class="text-2xl text-primary"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">Total Productos</div>
                        <div class="text-2xl font-semibold">{{ total_products }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-success/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="checkmark-circle-outline" class="text-2xl text-success"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">En Stock</div>
                        <div class="text-2xl font-semibold">{{ products_in_stock }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-warning/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="alert-circle-outline" class="text-2xl text-warning"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">Stock Bajo</div>
                        <div class="text-2xl font-semibold">{{ products_low_stock }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-success/10 rounded-xl flex items-center justify-center">
                        <ion-icon name="cash-outline" class="text-2xl text-success"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm text-medium">Valor Total</div>
                        <div class="text-2xl font-semibold">${{ total_inventory_value|floatformat:2 }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Products Table -->
    <ion-card class="my-4">
        <ion-card-header>
            <div class="flex justify-between items-center flex-wrap gap-3">
                <ion-card-title>{% trans "Listado de Productos" %}</ion-card-title>
                <div class="flex gap-2 flex-wrap">
                    <ion-button size="large" href="/plugins/inventory/products/create/">
                        <ion-icon slot="start" name="add-outline"></ion-icon>
                        {% trans "Nuevo Producto" %}
                    </ion-button>
                    <ion-button size="large" fill="outline" href="/plugins/inventory/products/export/csv/">
                        <ion-icon slot="start" name="download-outline"></ion-icon>
                        CSV
                    </ion-button>
                    <ion-button size="large" fill="outline" href="/plugins/inventory/products/export/excel/">
                        <ion-icon slot="start" name="document-outline"></ion-icon>
                        Excel
                    </ion-button>
                </div>
            </div>
        </ion-card-header>

        <!-- Search Bar -->
        <div class="px-4 pb-4">
            <div class="relative flex-1">
                <ion-icon
                    name="search-outline"
                    class="absolute left-3 top-1/2 -translate-y-1/2"
                    style="color: var(--ion-color-medium); pointer-events: none; z-index: 10;">
                </ion-icon>
                <input
                    type="text"
                    name="search"
                    value="{{ request.GET.search|default:'' }}"
                    placeholder="{% trans 'Buscar productos...' %}"
                    class="w-full h-10 pl-10 pr-3 rounded-lg"
                    style="border: 1px solid var(--ion-border-color); background: var(--ion-background-color); color: var(--ion-text-color);"
                    hx-get="{{ request.path }}"
                    hx-trigger="keyup changed delay:400ms"
                    hx-target="#products-table-container"
                    hx-include="[name='page'],[name='order_by'],[name='per_page']"
                    hx-push-url="true">
            </div>
        </div>

        <!-- Table Container (HTMX updates this) -->
        <div id="products-table-container">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead style="background: var(--ion-color-step-50);">
                        <tr>
                            <!-- ID -->
                            <th class="px-4 py-3 text-left text-sm font-medium" style="color: var(--ion-color-medium); width: 80px;">
                                ID
                            </th>

                            <!-- Image -->
                            <th class="px-4 py-3 text-left text-sm font-medium" style="color: var(--ion-color-medium); width: 80px;">
                                {% trans "Imagen" %}
                            </th>

                            <!-- Name (sortable) -->
                            <th
                                class="px-4 py-3 text-left text-sm font-medium cursor-pointer hover:bg-opacity-80 select-none"
                                style="color: var(--ion-color-medium);"
                                hx-get="{{ request.path }}"
                                hx-target="#products-table-container"
                                hx-include="[name='search'],[name='page'],[name='per_page']"
                                hx-vals='{"order_by": "{% if request.GET.order_by == "name" %}-name{% elif request.GET.order_by == "-name" %}name{% else %}-name{% endif %}"}'
                                hx-push-url="true">
                                {% trans "Nombre" %}
                                {% if request.GET.order_by == "name" %}
                                <ion-icon name="chevron-up-outline" style="font-size: 14px; vertical-align: middle;"></ion-icon>
                                {% elif request.GET.order_by == "-name" %}
                                <ion-icon name="chevron-down-outline" style="font-size: 14px; vertical-align: middle;"></ion-icon>
                                {% endif %}
                            </th>

                            <!-- SKU (sortable) -->
                            <th
                                class="px-4 py-3 text-left text-sm font-medium cursor-pointer hover:bg-opacity-80 select-none"
                                style="color: var(--ion-color-medium);"
                                hx-get="{{ request.path }}"
                                hx-target="#products-table-container"
                                hx-include="[name='search'],[name='page'],[name='per_page']"
                                hx-vals='{"order_by": "{% if request.GET.order_by == "sku" %}-sku{% elif request.GET.order_by == "-sku" %}sku{% else %}-sku{% endif %}"}'
                                hx-push-url="true">
                                {% trans "SKU" %}
                                {% if request.GET.order_by == "sku" %}
                                <ion-icon name="chevron-up-outline" style="font-size: 14px; vertical-align: middle;"></ion-icon>
                                {% elif request.GET.order_by == "-sku" %}
                                <ion-icon name="chevron-down-outline" style="font-size: 14px; vertical-align: middle;"></ion-icon>
                                {% endif %}
                            </th>

                            <!-- Price (sortable) -->
                            <th
                                class="px-4 py-3 text-left text-sm font-medium cursor-pointer hover:bg-opacity-80 select-none"
                                style="color: var(--ion-color-medium);"
                                hx-get="{{ request.path }}"
                                hx-target="#products-table-container"
                                hx-include="[name='search'],[name='page'],[name='per_page']"
                                hx-vals='{"order_by": "{% if request.GET.order_by == "price" %}-price{% elif request.GET.order_by == "-price" %}price{% else %}-price{% endif %}"}'
                                hx-push-url="true">
                                {% trans "Precio" %}
                                {% if request.GET.order_by == "price" %}
                                <ion-icon name="chevron-up-outline" style="font-size: 14px; vertical-align: middle;"></ion-icon>
                                {% elif request.GET.order_by == "-price" %}
                                <ion-icon name="chevron-down-outline" style="font-size: 14px; vertical-align: middle;"></ion-icon>
                                {% endif %}
                            </th>

                            <!-- Stock (sortable) -->
                            <th
                                class="px-4 py-3 text-left text-sm font-medium cursor-pointer hover:bg-opacity-80 select-none"
                                style="color: var(--ion-color-medium);"
                                hx-get="{{ request.path }}"
                                hx-target="#products-table-container"
                                hx-include="[name='search'],[name='page'],[name='per_page']"
                                hx-vals='{"order_by": "{% if request.GET.order_by == "stock" %}-stock{% elif request.GET.order_by == "-stock" %}stock{% else %}-stock{% endif %}"}'
                                hx-push-url="true">
                                {% trans "Stock" %}
                                {% if request.GET.order_by == "stock" %}
                                <ion-icon name="chevron-up-outline" style="font-size: 14px; vertical-align: middle;"></ion-icon>
                                {% elif request.GET.order_by == "-stock" %}
                                <ion-icon name="chevron-down-outline" style="font-size: 14px; vertical-align: middle;"></ion-icon>
                                {% endif %}
                            </th>

                            <!-- Actions -->
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium); width: 150px;">
                                {% trans "Acciones" %}
                            </th>
                        </tr>
                    </thead>
                    {% include "inventory/partials/products_table_rows.html" %}
                </table>
            </div>

            <ion-card-content>
                {% include "inventory/partials/products_pagination.html" %}
            </ion-card-content>
        </div>
    </ion-card>
</div>
{% endblock %}
